<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>{% if page %}{{ page.title }} | {% endif %}{{ config.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ get_url(path='main.css', cachebust=true) }}">
  <script>
    // Apply saved or preferred theme early to avoid FOUC
    (function(){
      try {
        const saved = localStorage.getItem('theme');
        const prefDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      } catch (e) {}
    })();
  </script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="left">
      <button id="menu-toggle" class="menu-toggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-nav">
        <!-- Hamburger icon (closed) -->
        <svg class="icon-hamburger" viewBox="0 0 32 32" width="28" height="28" aria-hidden="true">
          <path class="l1" d="M4 8h24"></path>
          <path class="l2" d="M4 16h24"></path>
          <path class="l3" d="M4 24h24"></path>
        </svg>
        <!-- Close icon (open) -->
        <svg class="icon-close" viewBox="0 0 32 32" width="28" height="28" aria-hidden="true">
          <path d="M7 7L25 25"></path>
          <path d="M25 7L7 25"></path>
        </svg>
      </button>
      <a class="brand" href="{{ get_url(path='@/_index.md') }}">{{ config.title }}</a>
    </div>
    <div class="right">
      <nav class="nav-desktop">
        <a href="{{ get_url(path='@/articles/_index.md') }}">Articles</a>
        <a href="{{ get_url(path='tags') }}/">Tags</a>
        <a href="{{ get_url(path='categories') }}/">Categories</a>
      </nav>
      <button id="theme-toggle" class="theme-switch" type="button" aria-label="Toggle theme" title="Toggle theme" aria-pressed="false">
        <span class="switch-track">
          <span class="switch-icons" aria-hidden="true">
            <!-- sun -->
            <svg class="icon sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
            <!-- moon -->
            <svg class="icon moon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"/></svg>
          </span>
          <span class="switch-thumb" aria-hidden="true"></span>
        </span>
      </button>
    </div>
  </div>
  </header>
<nav id="mobile-nav" class="mobile-nav" hidden>
  <a href="{{ get_url(path='@/articles/_index.md') }}">Articles</a>
  <a href="{{ get_url(path='tags') }}/">Tags</a>
  <a href="{{ get_url(path='categories') }}/">Categories</a>
</nav>
<main>
  <div class="wrap">
    {% block content %}{% endblock content %}
  </div>
</main>
<footer>
  <div class="wrap">
    <p>&copy; {{ now() | date(format="%Y") }} etak64n</p>
  </div>
</footer>
</body>
<script>
  // Theme toggle wiring (single button at top-right)
  (function(){
    const btn = document.getElementById('theme-toggle');
    function current(){ return document.documentElement.getAttribute('data-theme') || 'light'; }
    function reflect(mode){ if(!btn) return; btn.setAttribute('data-mode', mode); btn.setAttribute('aria-pressed', String(mode==='dark')); btn.title = `Toggle theme (${mode})`; }
    function apply(mode){ document.documentElement.setAttribute('data-theme', mode); try{ localStorage.setItem('theme', mode);}catch(e){} reflect(mode); }
    if (btn) {
      reflect(current());
      btn.addEventListener('click', function(){ apply(current()==='dark' ? 'light' : 'dark'); });
    }
    // Sync with OS preference changes if user hasn't explicitly chosen
    try {
      const saved = localStorage.getItem('theme');
      if (!saved && window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        const handler = e => apply(e.matches ? 'dark' : 'light');
        mq.addEventListener ? mq.addEventListener('change', handler) : mq.addListener && mq.addListener(handler);
      }
    } catch(e){}
  })();

  // Mobile menu toggle
  (function(){
    const html = document.documentElement;
    const btn = document.getElementById('menu-toggle');
    const panel = document.getElementById('mobile-nav');
    if (!btn || !panel) return;
    // Keep layout aligned by reflecting actual header height to CSS var
    function updateHeaderHeight(){
      const header = document.querySelector('header');
      if (!header) return;
      const h = Math.round(header.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }
    updateHeaderHeight();
    let rhTimer;
    window.addEventListener('resize', function(){
      clearTimeout(rhTimer);
      rhTimer = setTimeout(updateHeaderHeight, 120);
    }, {passive:true});
    function setOpen(open){
      html.setAttribute('data-menu', open ? 'open' : 'closed');
      btn.setAttribute('aria-expanded', String(open));
      if (open) panel.removeAttribute('hidden'); else panel.setAttribute('hidden','');
    }
    btn.addEventListener('click', function(){ setOpen(!(html.getAttribute('data-menu')==='open')); });
    document.addEventListener('keydown', function(e){ if (e.key==='Escape') setOpen(false); }, {passive:true});
    // Close when clicking a link
    panel.addEventListener('click', function(e){ const target = e.target; if (target && target.tagName==='A') setOpen(false); });
  })();

  document.addEventListener('DOMContentLoaded', function () {
    const blocks = document.querySelectorAll('.content pre > code');
    blocks.forEach(code => {
      const pre = code.parentElement;
      if (!pre || pre.classList.contains('codebox-pre') || pre.parentElement?.classList.contains('codebox')) return;

      // Detect optional filename on the first line (various comment syntaxes supported)
      const text = code.textContent || '';
      const firstLine = text.split('\n')[0] || '';
      const m = firstLine.match(/^\s*(?:\/\/|#|;|--|%|\/\*|<!--)?\s*filename\s*[:=]\s*(.+?)(?:\s*\*\/|-->|)\s*$/i);
      const hasTitle = !!m;
      const title = hasTitle ? m[1].trim() : '';
      const hasExt = hasTitle ? /(\.|^)([^\/\s]+)\.[A-Za-z0-9]+$/.test(title) : false;

      // If a filename header is embedded, drop that first line from the code
      if (hasTitle && hasExt) {
        const html = code.innerHTML;
        const idx = html.indexOf('\n');
        if (idx > -1) code.innerHTML = html.slice(idx + 1);
      }

      // Wrap every code block in a unified dark codebox for consistent styling
      const wrapper = document.createElement('div');
      wrapper.className = 'codebox dark';
      const bar = document.createElement('div');
      bar.className = 'codebox-bar';
      const preClone = pre.cloneNode(true);
      preClone.classList.add('codebox-pre');
      if (hasTitle && hasExt) {
        preClone.classList.add('has-title');
        const pill = document.createElement('div');
        pill.className = 'codebox-title-inside';
        pill.textContent = title;
        preClone.insertBefore(pill, preClone.firstChild);
      }
      wrapper.appendChild(bar);

      // Add copy button
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'codebox-copy';
      btn.setAttribute('aria-label', 'Copy code');
      btn.textContent = 'Copy';
      preClone.appendChild(btn);
      const codeInClone = preClone.querySelector('code');
      btn.addEventListener('click', async () => {
        const text = codeInClone ? codeInClone.innerText : '';
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          const old = btn.textContent;
          btn.textContent = 'Copied';
          btn.classList.add('copied');
          setTimeout(() => { btn.textContent = old; btn.classList.remove('copied'); }, 1200);
        } catch (e) {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = 'Copy'; }, 1200);
        }
      });

      wrapper.appendChild(preClone);
      pre.replaceWith(wrapper);
    });
  });
</script>
</html>
